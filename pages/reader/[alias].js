import Layout from '@/components/Layout';\nimport ChatMessage from '@/components/ChatMessage';\nimport { supabase } from '@/lib/supabaseClient';\nimport { useState, useRef, useEffect } from 'react';\n\nexport async function getServerSideProps({ params }) {\n  const { data: reader } = await supabase\n    .from('readers')\n    .select('*')\n    .eq('alias', params.alias)\n    .single();\n\n  if (!reader) return { notFound: true };\n\n  const { data: stats } = await supabase\n    .from('card_stats')\n    .select('card_name, image_url, draw_count')\n    .eq('reader', reader.alias)\n    .order('draw_count', { ascending: false })\n    .limit(3);\n\n  return { props: { reader, stats: stats || [] } };\n}\n\nexport default function ReaderPage({ reader, stats }) {\n  const [messages, setMessages] = useState([\n    { role: 'reader', content: `✨ I am ${reader.name}. ${reader.tagline}` },\n  ]);\n\n  const [input, setInput] = useState('');\n  const [typing, setTyping] = useState(false);\n  const endRef = useRef(null);\n\n  useEffect(() => {\n    endRef.current?.scrollIntoView({ behavior: 'smooth' });\n  }, [messages]);\n\n  async function sendMessage(e) {\n    e.preventDefault();\n    if (!input.trim()) return;\n\n    const userMsg = { role: 'user', content: input };\n    setMessages((m) => [...m, userMsg]);\n    setInput('');\n    setTyping(true);\n\n    try {\n      const res = await fetch('/api/askReader', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ reader, question: userMsg.content }),\n      });\n\n      const data = await res.json();\n\n      const botMsg = {\n        role: 'reader',\n        content: data.message || '✨ The spirits are quiet...'\n      };\n\n      setMessages((m) => [...m, botMsg]);\n\n    } finally { setTyping(false); }\n  }\n\n  return (\n    <Layout title={reader.name}>\n      <div className='max-w-2xl mx-auto py-16 space-y-14'>\n\n        <header className='text-center space-y-3'>\n          <img\n            src={reader.image_url}\n            className='w-32 h-32 rounded-full mx-auto border-4 border-purple-700'\n          />\n          <h1 className='text-4xl text-yellow-300'>{reader.emoji} {reader.name}</h1>\n          <p className='text-purple-300 italic'>{reader.tagline}</p>\n        </header>\n\n        <div className='bg-purple-950/40 border border-purple-700 rounded-2xl p-4 h-[470px] flex flex-col'>\n          <div className='flex-1 overflow-y-auto space-y-4 mb-4 pr-2'>\n            {messages.map((msg, i) => (\n              <ChatMessage\n                key={i}\n                from={msg.role === 'reader' ? 'reader' : 'user'}\n                text={msg.content}\n              />\n            ))}\n\n            {typing && <ChatMessage from='reader' text='✨ typing...' />}\n            <div ref={endRef} />\n          </div>\n\n          <form onSubmit={sendMessage} className='flex'>\n            <input\n              value={input}\n              onChange={(e) => setInput(e.target.value)}\n              placeholder='Ask your question...'\n              className='flex-1 bg-purple-800/40 border border-purple-700 rounded-l-lg px-3 py-2 text-purple-100'\n            />\n            <button className='px-4 bg-yellow-400 rounded-r-lg text-purple-900 font-semibold'>\n              Send\n            </button>\n          </form>\n        </div>\n\n        {stats.length > 0 && (\n          <section className='text-center'>\n            <h2 className='text-2xl text-yellow-300 mb-3'>✨ Most Drawn Cards</h2>\n            <div className='flex justify-center gap-6 flex-wrap'>\n              {stats.map((c, i) => (\n                <div key={i} className='w-28 bg-purple-900/40 border border-purple-700 p-3 rounded-xl'>\n                  <img src={c.image_url} className='w-full h-36 rounded-md mb-1 object-cover' />\n                  <p className='text-yellow-300 text-sm'>{c.card_name}</p>\n                  <p className='text-purple-400 text-xs'>{c.draw_count} \u00D7 drawn</p>\n                </div>\n              ))}\n            </div>\n          </section>\n        )}\n\n      </div>\n    </Layout>\n  );\n}